# ğŸ“§ HTMLé‚®ä»¶æ¨¡æ¿åŠŸèƒ½ - å®Œå–„æ–¹æ¡ˆï¼ˆçº¯åŠŸèƒ½ç‰ˆï¼‰

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

ä¸ºEasoné‚®ä»¶åŠ©æ‰‹æ·»åŠ HTMLé‚®ä»¶æ¨¡æ¿åŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¯ä»¥å‘é€ç²¾ç¾çš„HTMLé‚®ä»¶ï¼Œè€Œä¸ä»…ä»…æ˜¯çº¯æ–‡æœ¬ã€‚

---

## ğŸ“¦ æ ¸å¿ƒåŠŸèƒ½æ¸…å•

### 1. æ¨¡æ¿å¼•æ“ï¼ˆTemplateEngineï¼‰

**åŠŸèƒ½**ï¼š
- âœ… åŠ è½½HTMLæ¨¡æ¿æ–‡ä»¶
- âœ… å˜é‡æ›¿æ¢ï¼ˆæ”¯æŒå ä½ç¬¦å¦‚ `{name}`ï¼‰
- âœ… æ¨¡æ¿éªŒè¯ï¼ˆæ£€æŸ¥HTMLè¯­æ³•ï¼‰
- âœ… æ¨¡æ¿å…ƒæ•°æ®ç®¡ç†
- âœ… å®‰å…¨çš„HTMLè½¬ä¹‰ï¼ˆé˜²æ­¢XSSï¼‰

**æ–°å¢æ”¹è¿›**ï¼š
- âœ¨ æ”¯æŒä»è”ç³»äººCSVä¸­æå–é¢å¤–å­—æ®µä½œä¸ºå˜é‡
- âœ¨ æ¨¡æ¿å…ƒæ•°æ®æ–‡ä»¶ï¼ˆJSONæ ¼å¼ï¼‰
- âœ¨ ç¼ºå¤±å˜é‡çš„é»˜è®¤å€¼å¤„ç†
- âœ¨ æ¨¡æ¿é¢„ç¼–è¯‘ç¼“å­˜ï¼ˆæå‡æ€§èƒ½ï¼‰

---

### 2. å†…ç½®HTMLæ¨¡æ¿

**åŸºç¡€æ¨¡æ¿**ï¼ˆ3ä¸ªï¼‰ï¼š
1. **å•†åŠ¡é‚€è¯·æ¨¡æ¿** (business.html)
   - é€‚ç”¨åœºæ™¯ï¼šå•†åŠ¡æ´»åŠ¨ã€ä¼šè®®é‚€è¯·
   - é£æ ¼ï¼šä¸“ä¸šã€æ­£å¼
   - é¢œè‰²ï¼šè“ç´«æ¸å˜

2. **æ–°é—»é€šè®¯æ¨¡æ¿** (newsletter.html)
   - é€‚ç”¨åœºæ™¯ï¼šäº§å“æ›´æ–°ã€æ–°é—»å‘å¸ƒ
   - é£æ ¼ï¼šç°ä»£ã€æ¸…æ–°
   - é¢œè‰²ï¼šç»¿è‰²

3. **ç®€æ´é€šçŸ¥æ¨¡æ¿** (invitation.html)
   - é€‚ç”¨åœºæ™¯ï¼šé€šçŸ¥ã€æé†’
   - é£æ ¼ï¼šç®€çº¦ã€å¡ç‰‡å¼
   - é¢œè‰²ï¼šè“è‰²

**æ¨¡æ¿å…ƒæ•°æ®** (template_meta.json)ï¼š
```json
{
  "business": {
    "name": "business",
    "display_name": "å•†åŠ¡é‚€è¯·",
    "description": "é€‚åˆå•†åŠ¡æ´»åŠ¨ã€ä¼šè®®é‚€è¯·ç­‰æ­£å¼åœºåˆ",
    "category": "formal",
    "author": "Eason Team",
    "version": "1.0",
    "required_vars": ["recipient_name", "sender_company"],
    "optional_vars": ["custom_1", "custom_2", "custom_3"],
    "preview_image": "business_preview.png"
  }
}
```

---

### 3. å˜é‡ç³»ç»Ÿï¼ˆå¢å¼ºç‰ˆï¼‰

**å†…ç½®å˜é‡**ï¼š
```python
{
    # æ”¶ä»¶äººä¿¡æ¯ï¼ˆè‡ªåŠ¨æå–ï¼‰
    'recipient_email': 'æ”¶ä»¶äººé‚®ç®±',
    'recipient_name': 'æ”¶ä»¶äººå§“åï¼ˆä»é‚®ç®±æå–ï¼‰',
    
    # å‘ä»¶äººä¿¡æ¯ï¼ˆç”¨æˆ·é…ç½®ï¼‰
    'sender_name': 'å‘ä»¶äººå§“å',
    'sender_company': 'å‘ä»¶äººå…¬å¸',
    'sender_email': 'å‘ä»¶äººé‚®ç®±',
    
    # ç³»ç»Ÿå˜é‡ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
    'date': 'å½“å‰æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰',
    'time': 'å½“å‰æ—¶é—´ï¼ˆHH:MMï¼‰',
    'datetime': 'å½“å‰æ—¥æœŸæ—¶é—´',
    'year': 'å½“å‰å¹´ä»½',
    
    # è‡ªå®šä¹‰å˜é‡ï¼ˆç”¨æˆ·è¾“å…¥ï¼‰
    'custom_1': 'è‡ªå®šä¹‰å­—æ®µ1',
    'custom_2': 'è‡ªå®šä¹‰å­—æ®µ2',
    'custom_3': 'è‡ªå®šä¹‰å­—æ®µ3',
    'custom_4': 'è‡ªå®šä¹‰å­—æ®µ4',
    'custom_5': 'è‡ªå®šä¹‰å­—æ®µ5',
}
```

**ä»CSVæå–å˜é‡**ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰ï¼š
- å¦‚æœè”ç³»äººæ–‡ä»¶æ˜¯CSVæ ¼å¼ï¼Œæ”¯æŒè¯»å–é¢å¤–åˆ—
- ä¾‹å¦‚CSVæœ‰åˆ—ï¼š`email,name,company,title`
- å¯ä»¥ä½¿ç”¨å˜é‡ï¼š`{recipient_name}`, `{recipient_company}`, `{recipient_title}`

**å˜é‡é»˜è®¤å€¼**ï¼š
```python
# å¦‚æœå˜é‡æœªæä¾›ï¼Œä½¿ç”¨é»˜è®¤å€¼
{recipient_name} â†’ æœªæä¾›æ—¶æ˜¾ç¤º "å°Šæ•¬çš„ç”¨æˆ·"
{sender_company} â†’ æœªæä¾›æ—¶æ˜¾ç¤º "æˆ‘ä»¬çš„å›¢é˜Ÿ"
```

---

### 4. UIç•Œé¢åŠŸèƒ½

#### 4.1 ä¸»çª—å£æ”¹é€ 

**æ–°å¢æ§ä»¶**ï¼ˆåœ¨"æ‰¹é‡å‘é€"æ ‡ç­¾é¡µï¼‰ï¼š

1. **æ¨¡æ¿å¯ç”¨å¼€å…³**
   ```
   â˜ ä½¿ç”¨HTMLæ¨¡æ¿
   ```

2. **æ¨¡æ¿é€‰æ‹©åŒºåŸŸ**
   ```
   é€‰æ‹©æ¨¡æ¿: [ä¸‹æ‹‰æ¡†] [é¢„è§ˆæŒ‰é’®] [ç®¡ç†æŒ‰é’®]
   ```

3. **å˜é‡é…ç½®æŒ‰é’®**
   ```
   [âš™ï¸ é…ç½®å˜é‡] [â„¹ï¸ å˜é‡å¸®åŠ©]
   ```

4. **æ¨¡æ¿æç¤ºä¿¡æ¯**
   ```
   ğŸ’¡ å½“å‰ä½¿ç”¨: å•†åŠ¡é‚€è¯·æ¨¡æ¿
   ğŸ“‹ å¿…å¡«å˜é‡: sender_company, custom_1
   ```

#### 4.2 æ¨¡æ¿é¢„è§ˆçª—å£

**åŠŸèƒ½**ï¼š
- âœ… æ¸²æŸ“HTMLé¢„è§ˆ
- âœ… æ”¯æŒå†…éƒ¨é“¾æ¥è·³è½¬
- âœ… æ˜¾ç¤ºå½“å‰å˜é‡å€¼
- âœ¨ æ”¯æŒåˆ‡æ¢ä¸åŒæ”¶ä»¶äººé¢„è§ˆï¼ˆæ–°å¢ï¼‰
- âœ¨ æ”¾å¤§/ç¼©å°é¢„è§ˆï¼ˆæ–°å¢ï¼‰
- âœ¨ å¯¼å‡ºé¢„è§ˆHTMLï¼ˆæ–°å¢ï¼‰

**ç•Œé¢**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“§ é‚®ä»¶æ¨¡æ¿é¢„è§ˆ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ”¶ä»¶äºº: [ä¸‹æ‹‰é€‰æ‹©] [åˆ·æ–°]             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚     [HTMLæ¸²æŸ“é¢„è§ˆåŒºåŸŸ]                â”‚
â”‚                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å¯¼å‡ºHTML] [æ‰“å°] [100% â–¼] [å…³é—­]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3 å˜é‡é…ç½®å¯¹è¯æ¡†

**åŠŸèƒ½**ï¼š
- âœ… è¾“å…¥æ‰€æœ‰å˜é‡å€¼
- âœ¨ æ˜¾ç¤ºå¿…å¡«/å¯é€‰æ ‡è®°ï¼ˆæ–°å¢ï¼‰
- âœ¨ æä¾›å˜é‡ä½¿ç”¨è¯´æ˜ï¼ˆæ–°å¢ï¼‰
- âœ¨ å®æ—¶éªŒè¯ï¼ˆæ–°å¢ï¼‰
- âœ¨ ä¿å­˜ä¸ºé…ç½®æ¨¡æ¿ï¼ˆæ–°å¢ï¼‰

**ç•Œé¢**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš™ï¸ é…ç½®æ¨¡æ¿å˜é‡                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¡ æç¤º: å¿…å¡«å˜é‡æ ‡è®°ä¸º *                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ * å‘ä»¶äººå§“å:     [____________]         â”‚
â”‚   â„¹ï¸ å°†æ˜¾ç¤ºåœ¨é‚®ä»¶ä¸­ä½œä¸ºå‘ä»¶äºº            â”‚
â”‚                                          â”‚
â”‚ * å‘ä»¶äººå…¬å¸:     [____________]         â”‚
â”‚   â„¹ï¸ æ˜¾ç¤ºåœ¨é‚®ä»¶å¤´éƒ¨å’Œç­¾åå¤„              â”‚
â”‚                                          â”‚
â”‚   è‡ªå®šä¹‰å­—æ®µ1:    [____________]         â”‚
â”‚   â„¹ï¸ å¯ç”¨äºæ´»åŠ¨æ—¶é—´ã€åœ°ç‚¹ç­‰ä¿¡æ¯          â”‚
â”‚                                          â”‚
â”‚   è‡ªå®šä¹‰å­—æ®µ2:    [____________]         â”‚
â”‚   è‡ªå®šä¹‰å­—æ®µ3:    [____________]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ä¿å­˜ä¸ºé…ç½®] [é‡ç½®] [ç¡®å®š] [å–æ¶ˆ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.4 æ¨¡æ¿ç®¡ç†çª—å£ï¼ˆæ–°å¢ï¼‰

**åŠŸèƒ½**ï¼š
- âœ… æŸ¥çœ‹æ‰€æœ‰æ¨¡æ¿
- âœ… é¢„è§ˆæ¨¡æ¿
- âœ… æŸ¥çœ‹æ¨¡æ¿è¯¦æƒ…
- âœ¨ åˆ é™¤è‡ªå®šä¹‰æ¨¡æ¿
- âœ¨ å¯¼å…¥æ¨¡æ¿ï¼ˆHTMLæ–‡ä»¶ï¼‰
- âœ¨ å¯¼å‡ºæ¨¡æ¿
- âœ¨ è®¾ç½®é»˜è®¤æ¨¡æ¿

**ç•Œé¢**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ æ¨¡æ¿ç®¡ç†                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…ç½®æ¨¡æ¿ (3)                                 â”‚
â”‚ â”œâ”€ [ğŸ“„] å•†åŠ¡é‚€è¯·     [é¢„è§ˆ] [è¯¦æƒ…]          â”‚
â”‚ â”œâ”€ [ğŸ“„] æ–°é—»é€šè®¯     [é¢„è§ˆ] [è¯¦æƒ…]          â”‚
â”‚ â””â”€ [ğŸ“„] ç®€æ´é€šçŸ¥     [é¢„è§ˆ] [è¯¦æƒ…]          â”‚
â”‚                                              â”‚
â”‚ è‡ªå®šä¹‰æ¨¡æ¿ (0)                               â”‚
â”‚ â””â”€ (æš‚æ— )                                    â”‚
â”‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å¯¼å…¥æ¨¡æ¿] [å¯¼å‡ºæ‰€é€‰] [åˆ é™¤] [å…³é—­]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5. é‚®ä»¶å‘é€å™¨é›†æˆ

**EmailSender æ”¹é€ **ï¼š

```python
def _build_email(self, recipient: str) -> EmailMessage:
    msg = EmailMessage()
    msg['From'] = self.cfg['user']
    msg['To'] = recipient
    msg['Subject'] = self.cfg['subject']
    
    # åˆ¤æ–­æ˜¯å¦ä½¿ç”¨æ¨¡æ¿
    if self.cfg.get('use_template', False):
        try:
            # å‡†å¤‡å˜é‡
            variables = self._prepare_variables(recipient)
            
            # æ¸²æŸ“HTML
            engine = TemplateEngine()
            html_content = engine.render(
                self.cfg['template_name'], 
                variables
            )
            
            # è®¾ç½®å†…å®¹ï¼ˆå¤šéƒ¨åˆ†æ¶ˆæ¯ï¼‰
            msg.set_content(self.cfg.get('body', 'çº¯æ–‡æœ¬å¤‡ç”¨å†…å®¹'))
            msg.add_alternative(html_content, subtype='html')
            
        except TemplateError as e:
            # æ¨¡æ¿é”™è¯¯æ—¶é™çº§ä¸ºçº¯æ–‡æœ¬
            self.error_signal.emit(f"æ¨¡æ¿æ¸²æŸ“å¤±è´¥: {e}")
            msg.set_content(self.cfg['body'])
    else:
        # çº¯æ–‡æœ¬æ¨¡å¼
        msg.set_content(self.cfg['body'])
    
    return msg

def _prepare_variables(self, recipient: str) -> Dict:
    """å‡†å¤‡æ¨¡æ¿å˜é‡"""
    # æå–æ”¶ä»¶äººä¿¡æ¯
    recipient_info = self._extract_recipient_info(recipient)
    
    # åˆå¹¶æ‰€æœ‰å˜é‡
    variables = {
        # æ”¶ä»¶äºº
        'recipient_email': recipient,
        'recipient_name': recipient_info.get('name', recipient.split('@')[0]),
        **recipient_info,  # CSVä¸­çš„é¢å¤–å­—æ®µ
        
        # å‘ä»¶äºº
        'sender_name': self.cfg.get('sender_name', ''),
        'sender_company': self.cfg.get('sender_company', ''),
        'sender_email': self.cfg['user'],
        
        # ç³»ç»Ÿ
        'date': datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥'),
        'time': datetime.now().strftime('%H:%M'),
        'datetime': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'year': datetime.now().year,
        
        # è‡ªå®šä¹‰
        **self.cfg.get('custom_vars', {})
    }
    
    return variables
```

---

### 6. é…ç½®ç®¡ç†å¢å¼º

**ConfigManager æ–°å¢æ–¹æ³•**ï¼š

```python
def save_template_config(self, template_name: str, variables: Dict):
    """ä¿å­˜æ¨¡æ¿é…ç½®"""
    self.settings.setValue('template/name', template_name)
    self.settings.setValue('template/variables', json.dumps(variables))
    self.settings.setValue('template/enabled', True)

def load_template_config(self) -> Dict:
    """åŠ è½½æ¨¡æ¿é…ç½®"""
    return {
        'template_name': self.settings.value('template/name', ''),
        'variables': json.loads(
            self.settings.value('template/variables', '{}')
        ),
        'enabled': self.settings.value('template/enabled', False, type=bool)
    }

def save_variable_preset(self, name: str, variables: Dict):
    """ä¿å­˜å˜é‡é¢„è®¾ï¼ˆæ–°åŠŸèƒ½ï¼‰"""
    presets = self.load_variable_presets()
    presets[name] = variables
    self.settings.setValue('template/presets', json.dumps(presets))

def load_variable_presets(self) -> Dict:
    """åŠ è½½æ‰€æœ‰å˜é‡é¢„è®¾"""
    return json.loads(
        self.settings.value('template/presets', '{}')
    )
```

---

### 7. é”™è¯¯å¤„ç†ä¸æç¤º

**é”™è¯¯ç±»å‹**ï¼š

```python
class TemplateError(Exception):
    """æ¨¡æ¿ç›¸å…³é”™è¯¯åŸºç±»"""
    pass

class TemplateNotFoundError(TemplateError):
    """æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨"""
    pass

class TemplateRenderError(TemplateError):
    """æ¨¡æ¿æ¸²æŸ“å¤±è´¥"""
    pass

class VariableMissingError(TemplateError):
    """å¿…å¡«å˜é‡ç¼ºå¤±"""
    pass
```

**é”™è¯¯å¤„ç†ç­–ç•¥**ï¼š

1. **æ¨¡æ¿åŠ è½½å¤±è´¥**
   - æç¤ºç”¨æˆ·æ¨¡æ¿æ–‡ä»¶æŸå
   - è‡ªåŠ¨åˆ‡æ¢åˆ°çº¯æ–‡æœ¬æ¨¡å¼
   - è®°å½•é”™è¯¯æ—¥å¿—

2. **å˜é‡ç¼ºå¤±**
   - åˆ—å‡ºç¼ºå¤±çš„å¿…å¡«å˜é‡
   - ä½¿ç”¨é»˜è®¤å€¼å¡«å……å¯é€‰å˜é‡
   - åœ¨é¢„è§ˆä¸­é«˜äº®æ˜¾ç¤ºç¼ºå¤±å˜é‡

3. **HTMLæ¸²æŸ“å¤±è´¥**
   - é™çº§ä¸ºçº¯æ–‡æœ¬å‘é€
   - æç¤ºç”¨æˆ·æ£€æŸ¥æ¨¡æ¿è¯­æ³•
   - æä¾›æ¨¡æ¿éªŒè¯å·¥å…·

**ç”¨æˆ·æç¤º**ï¼š
```python
# å‹å¥½çš„é”™è¯¯æç¤º
if missing_vars:
    QMessageBox.warning(
        self,
        "å˜é‡é…ç½®ä¸å®Œæ•´",
        f"ä»¥ä¸‹å¿…å¡«å˜é‡æœªé…ç½®:\n" + 
        "\n".join(f"  â€¢ {var}" for var in missing_vars) +
        "\n\nè¯·åœ¨'é…ç½®å˜é‡'ä¸­è¡¥å……è¿™äº›ä¿¡æ¯ã€‚"
    )
```

---

### 8. è”ç³»äººCSVå¢å¼ºï¼ˆæ–°åŠŸèƒ½ï¼‰

**æ”¯æŒå¤šåˆ—CSV**ï¼š

å½“å‰æ ¼å¼ï¼š
```csv
test@example.com
user@test.com
```

å¢å¼ºæ ¼å¼ï¼š
```csv
email,name,company,title
test@example.com,å¼ ä¸‰,ABCå…¬å¸,ç»ç†
user@test.com,æå››,XYZå…¬å¸,æ€»ç›‘
```

**è¯»å–é€»è¾‘**ï¼š
```python
def read_contacts_with_info(filepath: str) -> List[Dict]:
    """
    è¯»å–å¢å¼ºæ ¼å¼çš„è”ç³»äºº
    
    Returns:
        [
            {
                'email': 'test@example.com',
                'name': 'å¼ ä¸‰',
                'company': 'ABCå…¬å¸',
                'title': 'ç»ç†'
            },
            ...
        ]
    """
    # æ£€æµ‹CSVæ ¼å¼
    if has_header(filepath):
        # ä½¿ç”¨pandasæˆ–csv.DictReaderè¯»å–
        return read_csv_with_columns(filepath)
    else:
        # å…¼å®¹æ—§æ ¼å¼ï¼Œåªæœ‰é‚®ç®±
        emails = read_emails_only(filepath)
        return [{'email': e} for e in emails]
```

---

### 9. æ¨¡æ¿éªŒè¯å·¥å…·ï¼ˆæ–°åŠŸèƒ½ï¼‰

**åŠŸèƒ½**ï¼š
- æ£€æŸ¥HTMLè¯­æ³•
- æ£€æŸ¥CSSå…¼å®¹æ€§
- æ£€æŸ¥å˜é‡ä½¿ç”¨
- æ£€æŸ¥é‚®ç®±å®¢æˆ·ç«¯å…¼å®¹æ€§

```python
class TemplateValidator:
    """æ¨¡æ¿éªŒè¯å™¨"""
    
    def validate(self, html: str) -> ValidationResult:
        """éªŒè¯æ¨¡æ¿"""
        errors = []
        warnings = []
        
        # 1. HTMLè¯­æ³•æ£€æŸ¥
        if not self._check_html_syntax(html):
            errors.append("HTMLè¯­æ³•é”™è¯¯")
        
        # 2. æ£€æŸ¥æœªä½¿ç”¨çš„å˜é‡
        defined_vars = self._extract_variables(html)
        unused = set(SUPPORTED_VARIABLES.keys()) - defined_vars
        if unused:
            warnings.append(f"æœªä½¿ç”¨çš„å˜é‡: {', '.join(unused)}")
        
        # 3. æ£€æŸ¥å±é™©çš„HTMLæ ‡ç­¾
        if self._has_script_tags(html):
            errors.append("ä¸å…è®¸ä½¿ç”¨<script>æ ‡ç­¾")
        
        # 4. æ£€æŸ¥CSSå…¼å®¹æ€§
        if self._has_external_css(html):
            warnings.append("å¤–éƒ¨CSSå¯èƒ½ä¸è¢«é‚®ç®±å®¢æˆ·ç«¯æ”¯æŒï¼Œå»ºè®®ä½¿ç”¨å†…è”æ ·å¼")
        
        return ValidationResult(
            valid=len(errors) == 0,
            errors=errors,
            warnings=warnings
        )
```

---

### 10. æ€§èƒ½ä¼˜åŒ–ï¼ˆæ–°åŠŸèƒ½ï¼‰

**æ¨¡æ¿ç¼“å­˜**ï¼š
```python
class TemplateEngine:
    def __init__(self):
        self._cache = {}  # æ¨¡æ¿ç¼“å­˜
    
    def load_template(self, name: str) -> str:
        """åŠ è½½æ¨¡æ¿ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        if name in self._cache:
            return self._cache[name]
        
        html = self._read_template_file(name)
        self._cache[name] = html
        return html
    
    def clear_cache(self):
        """æ¸…é™¤ç¼“å­˜ï¼ˆæ¨¡æ¿æ›´æ–°æ—¶è°ƒç”¨ï¼‰"""
        self._cache.clear()
```

**æ‰¹é‡æ¸²æŸ“ä¼˜åŒ–**ï¼š
```python
def batch_render(self, template_name: str, 
                 recipients: List[Dict]) -> List[str]:
    """æ‰¹é‡æ¸²æŸ“ï¼ˆç”¨äºé¢„è§ˆå¤šä¸ªæ”¶ä»¶äººï¼‰"""
    template = self.load_template(template_name)
    
    # é¢„ç¼–è¯‘æ¨¡æ¿ï¼ˆåªè§£æä¸€æ¬¡ï¼‰
    compiled = self._compile_template(template)
    
    # æ‰¹é‡æ¸²æŸ“
    results = []
    for recipient in recipients:
        html = self._render_compiled(compiled, recipient)
        results.append(html)
    
    return results
```

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ template_engine.py          âœ¨ æ–°å¢ï¼šæ¨¡æ¿å¼•æ“
â”‚   â”œâ”€â”€ template_validator.py       âœ¨ æ–°å¢ï¼šæ¨¡æ¿éªŒè¯å™¨
â”‚   â”œâ”€â”€ email_sender.py             ğŸ”§ ä¿®æ”¹ï¼šæ”¯æŒHTML
â”‚   â””â”€â”€ config_manager.py           ğŸ”§ ä¿®æ”¹ï¼šä¿å­˜æ¨¡æ¿é…ç½®
â”‚
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ main_window.py              ğŸ”§ ä¿®æ”¹ï¼šæ·»åŠ æ¨¡æ¿UI
â”‚   â”œâ”€â”€ template_preview.py         âœ¨ æ–°å¢ï¼šé¢„è§ˆå¯¹è¯æ¡†
â”‚   â”œâ”€â”€ variable_config_dialog.py   âœ¨ æ–°å¢ï¼šå˜é‡é…ç½®å¯¹è¯æ¡†
â”‚   â””â”€â”€ template_manager_dialog.py  âœ¨ æ–°å¢ï¼šæ¨¡æ¿ç®¡ç†å¯¹è¯æ¡†
â”‚
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ __init__.py                 âœ¨ æ–°å¢
â”‚   â”œâ”€â”€ template_meta.json          âœ¨ æ–°å¢ï¼šæ¨¡æ¿å…ƒæ•°æ®
â”‚   â”œâ”€â”€ business.html               âœ¨ æ–°å¢ï¼šå•†åŠ¡æ¨¡æ¿
â”‚   â”œâ”€â”€ newsletter.html             âœ¨ æ–°å¢ï¼šæ–°é—»æ¨¡æ¿
â”‚   â”œâ”€â”€ invitation.html             âœ¨ æ–°å¢ï¼šé€šçŸ¥æ¨¡æ¿
â”‚   â””â”€â”€ custom/                     âœ¨ æ–°å¢ï¼šç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿ç›®å½•
â”‚
â””â”€â”€ utils/
    â””â”€â”€ file_handler.py             ğŸ”§ ä¿®æ”¹ï¼šæ”¯æŒCSVå¤šåˆ—è¯»å–
```

---

## âœ… åŠŸèƒ½æ£€æŸ¥æ¸…å•

### å¿…é¡»å®ç°çš„æ ¸å¿ƒåŠŸèƒ½
- [ ] æ¨¡æ¿å¼•æ“åŸºç¡€åŠŸèƒ½ï¼ˆåŠ è½½ã€æ¸²æŸ“ã€éªŒè¯ï¼‰
- [ ] 3ä¸ªå†…ç½®HTMLæ¨¡æ¿
- [ ] å˜é‡ç³»ç»Ÿï¼ˆå†…ç½®+è‡ªå®šä¹‰ï¼‰
- [ ] UIé›†æˆï¼ˆå¼€å…³ã€é€‰æ‹©ã€é…ç½®ï¼‰
- [ ] é¢„è§ˆåŠŸèƒ½
- [ ] EmailSenderé›†æˆ
- [ ] é…ç½®ä¿å­˜/åŠ è½½
- [ ] é”™è¯¯å¤„ç†

### å¢å¼ºåŠŸèƒ½ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
- [ ] æ¨¡æ¿å…ƒæ•°æ®ç®¡ç†
- [ ] CSVå¤šåˆ—æ”¯æŒ
- [ ] å˜é‡é»˜è®¤å€¼
- [ ] æ¨¡æ¿ç®¡ç†çª—å£
- [ ] æ‰¹é‡é¢„è§ˆ
- [ ] æ¨¡æ¿éªŒè¯å·¥å…·
- [ ] æ¨¡æ¿å¯¼å…¥/å¯¼å‡º
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ï¼‰

### ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- [ ] å¿…å¡«å˜é‡æ ‡è®°
- [ ] å˜é‡å¸®åŠ©è¯´æ˜
- [ ] å‹å¥½çš„é”™è¯¯æç¤º
- [ ] æ¨¡æ¿åˆ‡æ¢ç¡®è®¤
- [ ] é…ç½®é¢„è®¾ä¿å­˜
- [ ] é¢„è§ˆç¼©æ”¾åŠŸèƒ½

---

## ğŸ”§ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶ï¼ˆ6ä¸ªï¼‰

1. **src/core/template_engine.py**
   - TemplateEngine ç±»
   - å˜é‡æ›¿æ¢é€»è¾‘
   - æ¨¡æ¿åŠ è½½ä¸ç¼“å­˜

2. **src/core/template_validator.py**
   - TemplateValidator ç±»
   - HTMLè¯­æ³•æ£€æŸ¥
   - å…¼å®¹æ€§æ£€æŸ¥

3. **src/ui/template_preview.py**
   - TemplatePreviewDialog ç±»
   - HTMLæ¸²æŸ“é¢„è§ˆ
   - å¤šæ”¶ä»¶äººåˆ‡æ¢

4. **src/ui/variable_config_dialog.py**
   - VariableConfigDialog ç±»
   - å˜é‡è¾“å…¥è¡¨å•
   - å®æ—¶éªŒè¯

5. **src/ui/template_manager_dialog.py**
   - TemplateManagerDialog ç±»
   - æ¨¡æ¿åˆ—è¡¨ç®¡ç†
   - å¯¼å…¥å¯¼å‡ºåŠŸèƒ½

6. **src/templates/__init__.py**
   - æ¨¡æ¿åŒ…åˆå§‹åŒ–
   - å¯¼å‡º TemplateEngine

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

7. **src/core/email_sender.py**
   - ä¿®æ”¹ `_build_email()` æ–¹æ³•
   - æ·»åŠ  `_prepare_variables()` æ–¹æ³•
   - æ·»åŠ  `_extract_recipient_info()` æ–¹æ³•

8. **src/ui/main_window.py**
   - æ·»åŠ æ¨¡æ¿UIæ§ä»¶
   - æ·»åŠ æ¨¡æ¿ç›¸å…³æ§½å‡½æ•°
   - é›†æˆæ¨¡æ¿é…ç½®å¯¹è¯æ¡†

9. **src/core/config_manager.py**
   - æ·»åŠ  `save_template_config()` æ–¹æ³•
   - æ·»åŠ  `load_template_config()` æ–¹æ³•
   - æ·»åŠ å˜é‡é¢„è®¾ç®¡ç†æ–¹æ³•

### HTMLæ¨¡æ¿æ–‡ä»¶ï¼ˆ4ä¸ªï¼‰

10. **src/templates/template_meta.json**
    - æ¨¡æ¿å…ƒæ•°æ®

11. **src/templates/business.html**
    - å•†åŠ¡é‚€è¯·æ¨¡æ¿

12. **src/templates/newsletter.html**
    - æ–°é—»é€šè®¯æ¨¡æ¿

13. **src/templates/invitation.html**
    - ç®€æ´é€šçŸ¥æ¨¡æ¿

### å¯é€‰ä¿®æ”¹ï¼ˆ1ä¸ªï¼‰

14. **src/utils/file_handler.py**
    - æ·»åŠ  `read_contacts_with_info()` æ–¹æ³•
    - æ”¯æŒCSVå¤šåˆ—è¯»å–

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›ç‚¹æ€»ç»“

### ç›¸æ¯”åŸæ–¹æ¡ˆçš„æ”¹è¿›

1. âœ… **å»é™¤æ—¶é—´è§„åˆ’** - çº¯åŠŸèƒ½æè¿°
2. âœ¨ **å¢å¼ºå˜é‡ç³»ç»Ÿ** - æ”¯æŒCSVå¤šåˆ—ã€é»˜è®¤å€¼
3. âœ¨ **æ·»åŠ æ¨¡æ¿ç®¡ç†** - å¯¼å…¥å¯¼å‡ºã€åˆ é™¤ç¼–è¾‘
4. âœ¨ **å®Œå–„é”™è¯¯å¤„ç†** - é™çº§ç­–ç•¥ã€å‹å¥½æç¤º
5. âœ¨ **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ** - å¿…å¡«æ ‡è®°ã€å¸®åŠ©è¯´æ˜
6. âœ¨ **æ€§èƒ½ä¼˜åŒ–** - æ¨¡æ¿ç¼“å­˜ã€æ‰¹é‡æ¸²æŸ“
7. âœ¨ **æ¨¡æ¿éªŒè¯** - è¯­æ³•æ£€æŸ¥ã€å…¼å®¹æ€§æ£€æŸ¥

### åŠŸèƒ½å®Œæ•´æ€§

- âœ… æ ¸å¿ƒåŠŸèƒ½ï¼šæ¨¡æ¿æ¸²æŸ“ä¸å‘é€
- âœ… ç”¨æˆ·ä½“éªŒï¼šé¢„è§ˆã€é…ç½®ã€ç®¡ç†
- âœ… å¥å£®æ€§ï¼šé”™è¯¯å¤„ç†ã€é™çº§æ–¹æ¡ˆ
- âœ… æ‰©å±•æ€§ï¼šè‡ªå®šä¹‰æ¨¡æ¿ã€å¯¼å…¥å¯¼å‡º
- âœ… æ€§èƒ½ï¼šç¼“å­˜æœºåˆ¶ã€æ‰¹é‡å¤„ç†

---

## ğŸ“ æ€»ç»“

### è¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜ç‚¹

1. **åŠŸèƒ½å®Œæ•´** - è¦†ç›–ä»æ¨¡æ¿é€‰æ‹©åˆ°å‘é€çš„å®Œæ•´æµç¨‹
2. **ç”¨æˆ·å‹å¥½** - æ¸…æ™°çš„UIã€å‹å¥½çš„æç¤º
3. **å¥å£®æ€§å¼º** - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥
4. **æ˜“äºæ‰©å±•** - æ¨¡å—åŒ–è®¾è®¡ã€æ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿
5. **æ€§èƒ½ä¼˜åŒ–** - ç¼“å­˜æœºåˆ¶ã€æ‰¹é‡å¤„ç†

### ä»å¯æ”¹è¿›çš„åœ°æ–¹ï¼ˆå¯é€‰ï¼‰

- å¯è§†åŒ–æ¨¡æ¿ç¼–è¾‘å™¨ï¼ˆå¤æ‚ï¼Œå¯å»¶åï¼‰
- åœ¨çº¿æ¨¡æ¿å¸‚åœºï¼ˆéœ€è¦æœåŠ¡å™¨ï¼‰
- A/Bæµ‹è¯•åŠŸèƒ½ï¼ˆéœ€è¦ç»Ÿè®¡ï¼‰
- å¤šè¯­è¨€æ¨¡æ¿ï¼ˆéœ€è¦i18nï¼‰

---

**æ–¹æ¡ˆå·²å®Œå–„ï¼Œè¯·å®¡é˜…ã€‚å¦‚æ— é—®é¢˜ï¼Œæˆ‘ä»¬å¼€å§‹å®ç°ï¼** âœ…
